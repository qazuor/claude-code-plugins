name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  json-validation:
    name: Validate JSON files
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Validate plugin.json manifests
        run: |
          echo "Validating plugin.json files..."
          errors=0
          for f in plugins/*/.claude-plugin/plugin.json; do
            if ! jq empty "$f" 2>/dev/null; then
              echo "::error file=$f::Invalid JSON"
              errors=$((errors + 1))
            else
              echo "✓ $f"
            fi
          done
          if [ "$errors" -gt 0 ]; then
            echo "::error::$errors JSON file(s) failed validation"
            exit 1
          fi

      - name: Validate other JSON files
        run: |
          echo "Validating other JSON files..."
          errors=0
          for f in package.json plugins/*/hooks/*.json plugins/*/.mcp.json; do
            [ -f "$f" ] || continue
            if ! jq empty "$f" 2>/dev/null; then
              echo "::error file=$f::Invalid JSON"
              errors=$((errors + 1))
            else
              echo "✓ $f"
            fi
          done
          if [ "$errors" -gt 0 ]; then
            echo "::error::$errors JSON file(s) failed validation"
            exit 1
          fi

      - name: Validate MCP schema
        run: |
          echo "Validating MCP server configuration..."
          mcp_file="plugins/mcp-servers/.mcp.json"
          if [ -f "$mcp_file" ]; then
            # Check that mcpServers key exists and all servers have required fields
            # Supports two formats: command-based (command+args) and HTTP (type:http+url)
            servers=$(jq -r '.mcpServers | keys[]' "$mcp_file" 2>/dev/null)
            errors=0
            for server in $servers; do
              server_type=$(jq -r ".mcpServers[\"$server\"].type // empty" "$mcp_file")
              if [ "$server_type" = "http" ]; then
                # HTTP endpoint: requires type and url
                url=$(jq -r ".mcpServers[\"$server\"].url // empty" "$mcp_file")
                if [ -z "$url" ]; then
                  echo "::error file=$mcp_file::HTTP server '$server' missing required 'url' field"
                  errors=$((errors + 1))
                else
                  echo "✓ $server (http)"
                fi
              else
                # Command-based: requires command and args
                cmd=$(jq -r ".mcpServers[\"$server\"].command // empty" "$mcp_file")
                if [ -z "$cmd" ]; then
                  echo "::error file=$mcp_file::Server '$server' missing required 'command' field"
                  errors=$((errors + 1))
                fi
                args=$(jq -r ".mcpServers[\"$server\"].args // empty" "$mcp_file")
                if [ -z "$args" ]; then
                  echo "::error file=$mcp_file::Server '$server' missing required 'args' field"
                  errors=$((errors + 1))
                fi
                if [ -n "$cmd" ] && [ -n "$args" ]; then
                  echo "✓ $server (command)"
                fi
              fi
            done
            if [ "$errors" -gt 0 ]; then
              echo "::error::$errors MCP server(s) failed validation"
              exit 1
            else
              echo "✓ All MCP servers have required fields"
            fi
          fi

  shellcheck:
    name: Lint shell scripts
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install ShellCheck
        run: sudo apt-get install -y shellcheck

      - name: Run ShellCheck
        run: |
          echo "Running ShellCheck on all .sh files..."
          errors=0
          while IFS= read -r f; do
            if ! shellcheck -x "$f"; then
              errors=$((errors + 1))
            fi
          done < <(find . -name "*.sh" -type f)
          if [ "$errors" -gt 0 ]; then
            echo "::error::$errors script(s) failed ShellCheck"
            exit 1
          fi

  markdownlint:
    name: Lint Markdown files
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install markdownlint-cli
        run: npm install -g markdownlint-cli

      - name: Run markdownlint
        run: |
          markdownlint '**/*.md' --config .markdownlint.json

  plugin-structure:
    name: Verify plugin structure
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Check plugin directories have plugin.json
        run: |
          echo "Checking plugin structure..."
          errors=0
          for dir in plugins/*/; do
            plugin_name=$(basename "$dir")
            manifest="$dir.claude-plugin/plugin.json"
            if [ ! -f "$manifest" ]; then
              echo "::error::Plugin '$plugin_name' is missing .claude-plugin/plugin.json"
              errors=$((errors + 1))
            else
              echo "✓ $plugin_name has plugin.json"
            fi
          done
          if [ "$errors" -gt 0 ]; then
            echo "::error::$errors plugin(s) missing manifest"
            exit 1
          fi

      - name: Check plugin name matches directory
        run: |
          echo "Checking plugin names match directories..."
          errors=0
          for dir in plugins/*/; do
            plugin_dir=$(basename "$dir")
            manifest="$dir.claude-plugin/plugin.json"
            [ -f "$manifest" ] || continue
            manifest_name=$(jq -r '.name' "$manifest")
            if [ "$manifest_name" != "$plugin_dir" ]; then
              echo "::error file=$manifest::Plugin name '$manifest_name' does not match directory '$plugin_dir'"
              errors=$((errors + 1))
            else
              echo "✓ $plugin_dir name matches manifest"
            fi
          done
          if [ "$errors" -gt 0 ]; then
            echo "::error::$errors plugin(s) have mismatched names"
            exit 1
          fi

  skill-format:
    name: Validate skill format
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Check skills have SKILL.md
        run: |
          echo "Checking skill directories have SKILL.md..."
          errors=0
          for dir in plugins/*/skills/*/; do
            [ -d "$dir" ] || continue
            skill_name=$(basename "$dir")
            if [ ! -f "$dir/SKILL.md" ]; then
              echo "::error::Skill '$skill_name' is missing SKILL.md"
              errors=$((errors + 1))
            else
              echo "✓ $skill_name has SKILL.md"
            fi
          done
          if [ "$errors" -gt 0 ]; then
            echo "::error::$errors skill(s) missing SKILL.md"
            exit 1
          fi

      - name: Check skills have YAML frontmatter with description
        run: |
          echo "Checking skill frontmatter..."
          errors=0
          warnings=0
          for skill_file in plugins/*/skills/*/SKILL.md; do
            [ -f "$skill_file" ] || continue
            skill_name=$(basename "$(dirname "$skill_file")")

            # Check for frontmatter (starts with ---)
            first_line=$(head -n 1 "$skill_file")
            if [ "$first_line" != "---" ]; then
              echo "::error file=$skill_file::Skill '$skill_name' is missing YAML frontmatter"
              errors=$((errors + 1))
              continue
            fi

            # Check for closing --- (frontmatter end)
            closing_line=$(sed -n '2,${/^---$/=;};' "$skill_file" | head -n 1)
            if [ -z "$closing_line" ]; then
              echo "::error file=$skill_file::Skill '$skill_name' has unclosed YAML frontmatter"
              errors=$((errors + 1))
              continue
            fi

            # Check for description field
            frontmatter=$(sed -n "2,$((closing_line - 1))p" "$skill_file")
            if ! echo "$frontmatter" | grep -q "^description:"; then
              echo "::warning file=$skill_file::Skill '$skill_name' is missing recommended 'description' field"
              warnings=$((warnings + 1))
            fi
          done
          echo ""
          echo "Results: $errors error(s), $warnings warning(s)"
          if [ "$errors" -gt 0 ]; then
            echo "::error::$errors skill(s) failed format validation"
            exit 1
          fi

      - name: Check skill directory naming convention
        run: |
          echo "Checking skill naming conventions..."
          errors=0
          for dir in plugins/*/skills/*/; do
            [ -d "$dir" ] || continue
            skill_name=$(basename "$dir")
            if ! echo "$skill_name" | grep -qE '^[a-z0-9]+(-[a-z0-9]+)*$'; then
              echo "::error::Skill directory '$skill_name' does not follow kebab-case convention"
              errors=$((errors + 1))
            fi
          done
          if [ "$errors" -gt 0 ]; then
            echo "::error::$errors skill(s) have invalid naming"
            exit 1
          else
            echo "✓ All skill directories follow kebab-case convention"
          fi

  command-format:
    name: Validate command format
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Check commands have YAML frontmatter
        run: |
          echo "Checking command frontmatter..."
          errors=0
          warnings=0
          for cmd_file in plugins/*/commands/*.md; do
            [ -f "$cmd_file" ] || continue
            cmd_name=$(basename "$cmd_file" .md)

            # Check for frontmatter (starts with ---)
            first_line=$(head -n 1 "$cmd_file")
            if [ "$first_line" != "---" ]; then
              echo "::error file=$cmd_file::Command '$cmd_name' is missing YAML frontmatter"
              errors=$((errors + 1))
              continue
            fi

            # Check for closing ---
            closing_line=$(sed -n '2,${/^---$/=;};' "$cmd_file" | head -n 1)
            if [ -z "$closing_line" ]; then
              echo "::error file=$cmd_file::Command '$cmd_name' has unclosed YAML frontmatter"
              errors=$((errors + 1))
              continue
            fi

            # Check for description field
            frontmatter=$(sed -n "2,$((closing_line - 1))p" "$cmd_file")
            if ! echo "$frontmatter" | grep -q "^description:"; then
              echo "::warning file=$cmd_file::Command '$cmd_name' is missing recommended 'description' field"
              warnings=$((warnings + 1))
            fi
          done
          echo ""
          echo "Results: $errors error(s), $warnings warning(s)"
          if [ "$errors" -gt 0 ]; then
            echo "::error::$errors command(s) failed format validation"
            exit 1
          fi

      - name: Check command file naming convention
        run: |
          echo "Checking command naming conventions..."
          errors=0
          for cmd_file in plugins/*/commands/*.md; do
            [ -f "$cmd_file" ] || continue
            cmd_name=$(basename "$cmd_file" .md)
            if ! echo "$cmd_name" | grep -qE '^[a-z0-9]+(-[a-z0-9]+)*$'; then
              echo "::error::Command file '$cmd_name.md' does not follow kebab-case convention"
              errors=$((errors + 1))
            fi
          done
          if [ "$errors" -gt 0 ]; then
            echo "::error::$errors command(s) have invalid naming"
            exit 1
          else
            echo "✓ All command files follow kebab-case convention"
          fi

  test-suite:
    name: Run test suite
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Run tests
        run: bash tests/run-all.sh

  agent-format:
    name: Validate agent format
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Check agents have required frontmatter
        run: |
          echo "Checking agent frontmatter..."
          errors=0
          for agent_file in plugins/*/agents/*.md; do
            [ -f "$agent_file" ] || continue
            agent_name=$(basename "$agent_file" .md)

            # Check for frontmatter
            first_line=$(head -n 1 "$agent_file")
            if [ "$first_line" != "---" ]; then
              echo "::error file=$agent_file::Agent '$agent_name' is missing YAML frontmatter"
              errors=$((errors + 1))
              continue
            fi

            # Check for closing ---
            closing_line=$(sed -n '2,${/^---$/=;};' "$agent_file" | head -n 1)
            if [ -z "$closing_line" ]; then
              echo "::error file=$agent_file::Agent '$agent_name' has unclosed YAML frontmatter"
              errors=$((errors + 1))
              continue
            fi

            # Check required fields: name and description
            frontmatter=$(sed -n "2,$((closing_line - 1))p" "$agent_file")
            if ! echo "$frontmatter" | grep -q "^name:"; then
              echo "::error file=$agent_file::Agent '$agent_name' is missing required 'name' field"
              errors=$((errors + 1))
            fi
            if ! echo "$frontmatter" | grep -q "^description:"; then
              echo "::error file=$agent_file::Agent '$agent_name' is missing required 'description' field"
              errors=$((errors + 1))
            fi
          done
          if [ "$errors" -gt 0 ]; then
            echo "::error::$errors agent(s) failed format validation"
            exit 1
          else
            echo "✓ All agents have valid frontmatter"
          fi

